<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>3.4.1. Assigning Firewall Marks</title>
    <link rel="stylesheet" href="./Common_Content/css/default.css" type="text/css" />
    <link rel="start" href="index.html" title="Linux Virtual Server Administration" />
    <link rel="up" href="s1-lvs-multi-VSA.html" title="3.4. Multi-port Services and LVS" />
    <link rel="prev" href="s1-lvs-multi-VSA.html" title="3.4. Multi-port Services and LVS" />
    <link rel="next" href="s1-lvs-ftp-VSA.html" title="3.5. Configuring FTP" />
    <link rel="copyright" href="ln-id2872232.html" title="Legal Notice" />
  </head>
  <body>
    <p id="title">
      
        <strong>3.4.1. Assigning Firewall Marks</strong>
      </a>
    </p>
    <ul class="docnav">
      <li class="previous">
        <a accesskey="p" href="s1-lvs-multi-VSA.html">
          <strong>Prev</strong>
        </a>
      </li>
      <li class="next">
        <a accesskey="n" href="s1-lvs-ftp-VSA.html">
          <strong>Next</strong>
        </a>
      </li>
    </ul>
    <div class="section" lang="en-US" xml:lang="en-US">
      <div class="titlepage">
        <div>
          <div>
            <h3 class="title"><a id="s2-lvs-fwm-VSA"></a>3.4.1. Assigning Firewall Marks</h3>
          </div>
        </div>
      </div>
      <p>
				To assign firewall marks to a packet destined for a particular port, the administrator must use <code class="command">iptables</code>.
			</p>
      <p>
				This section illustrates how to bundle HTTP and HTTPS as an example; however, FTP is another commonly clustered multi-port protocol. If an LVS is used for FTP services, refer to <a href="s1-lvs-ftp-VSA.html" title="3.5. Configuring FTP">Section 3.5, “Configuring FTP”</a> for configuration details.
			</p>
      <p>
				The basic rule to remember when using firewall marks is that for every protocol using a firewall mark in <span><strong class="application">Piranha Configuration Tool</strong></span> there must be a commensurate <code class="command">iptables</code> rule to assign marks to the network packets.
			</p>
      <p>
				Before creating network packet filter rules, make sure there are no rules already in place. To do this, open a shell prompt, login as root, and type:
			</p>
      <p>
				<code class="command">/sbin/service iptables status</code>
			</p>
      <p>
				If <code class="command">iptables</code> is not running, the prompt will instantly reappear.
			</p>
      <p>
				If <code class="command">iptables</code> is active, it displays a set of rules. If rules are present, type the following command:
			</p>
      <p>
				<code class="command">/sbin/service iptables stop</code>
			</p>
      <p>
				If the rules already in place are important, check the contents of <code class="filename">/etc/sysconfig/iptables</code> and copy any rules worth keeping to a safe place before proceeding.
			</p>
      <p>
				Below are rules which assign the same firewall mark, 80, to incoming traffic destined for the floating IP address, <em class="replaceable"><code>n.n.n.n</code></em>, on ports 80 and 443.
			</p>
      <p>
				<code class="command">/sbin/modprobe ip_tables</code>
			</p>
      <p>
				<code class="command">/sbin/iptables -t mangle -A PREROUTING -p tcp -d <em class="replaceable"><code>n.n.n.n</code></em>/32 --dport 80 -j MARK --set-mark 80</code>
			</p>
      <p>
				<code class="command">/sbin/iptables -t mangle-A PREROUTING -p tcp -d <em class="replaceable"><code>n.n.n.n</code></em>/32 --dport 443 -j MARK --set-mark 80</code>
			</p>
      <p>
				For instructions on assigning the VIP to the public network interface, see <a href="s2-piranha-virtserv-sub-VSA.html" title="4.6.1. The VIRTUAL SERVER Subsection">Section 4.6.1, “The <span><strong class="guilabel">VIRTUAL SERVER</strong></span> Subsection”</a>. Also note that you must log in as root and load the module for <code class="command">iptables</code> before issuing rules for the first time.
			</p>
      <p>
				In the above <code class="command">iptables</code> commands, <em class="replaceable"><code>n.n.n.n</code></em> should be replaced with the floating IP for your HTTP and HTTPS virtual servers. These commands have the net effect of assigning any traffic addressed to the VIP on the appropriate ports a firewall mark of 80, which in turn is recognized by IPVS and forwarded appropriately.
			</p>
      <div class="warning">
        <h2>Warning</h2>
        <p>
					The commands above will take effect immediately, but do not persist through a reboot of the system. To ensure network packet filter settings are restored upon reboot, refer to <a href="s1-lvs-fwm-sav-VSA.html" title="3.6. Saving Network Packet Filter Settings">Section 3.6, “Saving Network Packet Filter Settings”</a>
				</p>
      </div>
    </div>
    <ul class="docnav">
      <li class="previous">
        <a accesskey="p" href="s1-lvs-multi-VSA.html"><strong>Prev</strong>3.4. Multi-port Services and LVS</a>
      </li>
      <li class="up">
        <a accesskey="u" href="#">
          <strong>Up</strong>
        </a>
      </li>
      <li class="home">
        <a accesskey="h" href="index.html">
          <strong>Home</strong>
        </a>
      </li>
      <li class="next">
        <a accesskey="n" href="s1-lvs-ftp-VSA.html"><strong>Next</strong>3.5. Configuring FTP</a>
      </li>
    </ul>
  <br><font size="1"><b>Note:</b> This documentation is provided {and copyrighted} by <b>Red Hat®, Inc.</b> and is released via the Open Publication License. The copyright holder has added the further requirement that <i>Distribution of substantively modified versions of this document is prohibited without the explicit permission of the copyright holder</i>. The <b>CentOS project</b> redistributes these original works (in their unmodified form) as a reference for <b>CentOS-5</b> because <b>CentOS-5</b> is built from publicly available, open source SRPMS. The documentation is unmodified to be compliant with upstream distribution policy. Neither <b>CentOS-5</b> nor the <b>CentOS Project</b> are in any way affiliated with or sponsored by <b>Red Hat®, Inc.</b></font></body>
</html>
